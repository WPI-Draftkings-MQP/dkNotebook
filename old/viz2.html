<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="viz.css">
</head>
<body>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.6.7/d3-tip.js"></script>
    <script>
      var categories = []
      function resetCategories(){
        categories = []
      }

      function getColor(n) {
          i = categories.indexOf(n)
          if(i == -1){
              categories.push(n);
              i = categories.indexOf(n);
          }
          //Stole colors from the google
          var colors = ["#3366cc", "#dc3912", "#ff9900", "#109618", "#990099", "#0099c6", "#dd4477", "#66aa00", "#b82e2e", "#316395", "#994499", "#22aa99", "#aaaa11", "#6633cc", "#e67300", "#8b0707", "#651067", "#329262", "#5574a6", "#3b3eac"];
          return colors[i % colors.length];
      }

      floatColumns = []
      stringColumns = []
      function getColTypes(data){
          var columns = []
          var allColumns = Object.keys(data[0]);
          for(var i = 0; i < allColumns.length; i++){
              var c = allColumns[i];
              if(c.includes("Datetime")){  continue;  }
              if(c.includes("HoursOut")){  continue;  }

              var val = parseFloat(data[1][c])
              if(!isNaN(val)) {  floatColumns.push({'text':c});   }
              else            {  stringColumns.push({'text':c});  }
          }
      }

    </script>

    <script>
      var defaultC = "SportName";
      var defaultX = "V52";
      var defaultY = "V53";
      var transitionTime = 500;

      var margin = {top: 100, right: 100, bottom: 100, left: 100},
          width = 1000 - margin.left - margin.right,
          height = 600 - margin.top - margin.bottom;

      var xScale = d3.scale.linear().range([0, width]);
      var yScale = d3.scale.linear().range([height, 0]);

      var xAxis = d3.svg.axis().scale(xScale).orient("bottom").ticks(5);
      var yAxis = d3.svg.axis().scale(yScale).orient("left").ticks(5);

      var body = d3.select('body')

      console.log("Loading Data...")
      d3.csv("data/VizData.csv", function(error, data) {
          console.log("... complete")

          data = data.slice(1000, 3000);

          getColTypes(data)
          setupSelectors()

          data.forEach(function(d){
            d.x = +d[defaultX];
            d.y = +d[defaultY];
            d.category = d[defaultC];
          })


          // Helper Functions
          function setupSelectors(){
              var span = body.append('span')
                .text('Select Categorical variable: ')
              var cInput = body.append('select')
                                  .attr('id','cSelect')
                                  .on('change',catChange)
                                .selectAll('option')
                                  .data(stringColumns).enter()
                                .append('option')
                                  .attr('value', function (d) { return d.text })
                                  .text(function (d) { return d.text ;})
                                .property("selected", function(d){return d.text === defaultC;})
              body.append('br')

              var span = body.append('span')
                .text('Select X-Axis variable: ')
              var xInput = body.append('select')
                                  .attr('id','xSelect')
                                  .on('change',xChange)
                                .selectAll('option')
                                  .data(floatColumns).enter()
                                .append('option')
                                  .attr('value', function (d) { return d.text })
                                  .text(function (d) { return d.text ;})
                                .property("selected", function(d){return d.text === defaultX;})
              body.append('br')

              var span = body.append('span')
                .text('Select Y-Axis variable: ')
              var yInput = body.append('select')
                                  .attr('id','ySelect')
                                  .on('change',yChange)
                                .selectAll('option')
                                  .data(floatColumns).enter()
                                .append('option')
                                  .attr('value', function (d) { return d.text })
                                  .text(function (d) { return d.text ;})
                                .property("selected", function(d){return d.text === defaultY;})


              body.append('br')
          }
          function catChange() {
            var value = this.value // get the new x value
            console.log("new Cat: " + value)
            data.forEach(function(d) {
                d.category = +d[value];
            });
            legend.data()
          }
          function xChange() {
            var value = this.value // get the new x value
            console.log("new X Axis: " + value)
            data.forEach(function(d) {
                d.x = +d[value];
            });
            xScale.domain(d3.extent(data, function(d) { return d.x; }));

            d3.select('.x_axis') // redraw the xAxis
                .transition().duration(transitionTime)
                .call(xAxis);
            d3.select('.xAxisLabel') // change the xAxisLabel
                .transition().duration(transitionTime)
                .text(value);
            d3.selectAll('circle') // move the circles
                .transition().duration(transitionTime)
                .attr('cx',function (d) { return xScale(d.x)})
          }
          function yChange() {
            var value = this.value // get the new x value
            console.log("new Y Axis: " + value)
            data.forEach(function(d) {
                d.y = +d[value];
            });
            yScale.domain(d3.extent(data, function(d) { return d.y; }));

            d3.select('.y_axis') // redraw the yAxis
              .transition().duration(transitionTime)
              .call(yAxis)
            d3.select('.yAxisLabel') // change the yAxisLabel
              .transition().duration(transitionTime)
              .text(value)
            d3.selectAll('circle') // move the circles
                .transition().duration(transitionTime)
                .attr('cy',function (d) { return yScale(d.y)})
          }


          var svg = body.append("svg")
                            .attr("width", width + margin.left + margin.right)
                            .attr("height", height + margin.top + margin.bottom)
                        .append("g")
                            .attr("transform",
                                  "translate(" + margin.left + "," + margin.top + ")");

          //Tooltip
          var tip = d3.tip()
              .attr("class", "d3-tip")
              .offset([-10, 0])
              .html(function(d) {
                        return "Contest id : " + d.ContestId + "<br>"+ d.ContestName + "<br>" +
                                "X: " + d.x + "\t|\t Y: " + d.y;
                      });
          svg.call(tip)

          //Axes
          xScale.domain(d3.extent(data, function(d) { return d.x; }));
          yScale.domain(d3.extent(data, function(d) { return d.y; }));

          svg.append("g")
              .attr("class", "x_axis")
              .attr("transform", "translate(0," + height + ")")
              .call(xAxis)
            .append('text') // y-axis Label
              .attr('class', 'xAxisLabel')
              .attr('x',width/2)
              .attr('y',margin.bottom/2+5)
              .style('text-anchor','middle')
              .text(defaultX);

          svg.append("g")
              .attr("class", "y_axis")
              .call(yAxis)
          .append('text') // y-axis Label
            .attr('class', 'yAxisLabel')
            .attr("transform", "rotate(90)")
            .attr('x',height/2)
            .attr('y',(margin.left/2)+5)
            .style('text-anchor','middle')
            .text(defaultY);

          svg.selectAll("dot")
              .data(data).enter().append("circle")
                  .attr("r", 3.5)
                  .classed("active", true)
                  .attr("cx", function(d) { return xScale(d.x); })
                  .attr("cy", function(d) { return yScale(d.y); })
                  .attr("opacity", .2)
                  .attr("fill", function(d,i) { return getColor(d.category); })
                  .on("mouseover", function(d){
                    // d3.selectAll(".cat_"+d.category).attr('opacity', 1);
                    // if(d3.select)
                    d3.select(this).attr("r", 5.0)
                    // if(d3.selectTH)
                    tip.show(d)
                  })
                  .on("mouseout", function(d){
                    d3.select(this).attr("r", 3.5)
                    // d3.selectAll(".cat_"+d.category).attr('opacity', .2);
                    tip.hide(d)
                  })
                  .on("click", function(d){
                    console.log(d);
                  });

          var legend = svg.selectAll(".legend")
              .data(categories)
              .enter().append("g")
              .classed("legend", true)
              .attr("transform", function(d, i) {
                  return "translate(0," + i * 20 + ")";
              });
          legend.append("rect")
              .attr("x", width + 10)
              .attr("width", 12)
              .attr("height", 12)
              .style("fill", function(d){return getColor(d)});
          legend.append("text")
              .attr("x", width - 26)
              .attr("dy", "1.0em")
              .attr("color", "black")
              .text(function(d) {
                  return d;
              });
          legend.on("click", function(type) {
            console.log("limiting to \'"+type +"\'");

              d3.selectAll(".legend")
                  .style("opacity", 0.1);
              d3.select(this)
                  .style("opacity", 1);
              // select all dots and apply 0 opacity (hide)
              d3.selectAll("circle")
                .transition()
                .duration(500)
                .style("opacity", 0.1)
              //   // filter out the ones we want to show and apply properties
                .filter(function(d) {
                    if(d.category == type){
                      d3.select(this).classed("active", true)
                      return true;
                    }else{
                      return false;
                    }
                })
                .style("opacity", 1) // need this line to unhide dots
                .style("stroke", "black")
          });
      });

    </script>
</body>
